<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cycling Day Planner â€“ Fuel, Strength & Recovery</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
  :root{
    --bg:#0b0e14; --card:#121826; --card2:#0f1421; --txt:#e9eef7; --muted:#aab4c8;
    --accent:#4f7cff; --accent2:#27c1a5; --warn:#f7b955; --danger:#ff6b6b; --ok:#7dd87d;
    --border:#26304a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
  header h1{font-size:20px;margin:0}
  nav{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:12px 0}
  .tab-btn{background:var(--card);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:12px;text-align:center;font-size:13px}
  .tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h2{font-size:18px;margin:0 0 8px;color:var(--muted)}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:14px}
  input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card2);color:var(--txt);font-size:14px}
  input[type="number"]{appearance:textfield}
  .row{display:grid;gap:10px}
  .row.two{grid-template-columns:1fr 1fr}
  .row.three{grid-template-columns:1fr 1fr 1fr}
  .row.four{grid-template-columns:repeat(4,1fr)}
  .stat{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:10px;font-size:14px}
  .stat b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .big{font-size:20px}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:0;border-radius:10px;padding:8px 12px;text-decoration:none;font-size:14px;cursor:pointer}
  .btn.alt{background:#2e3b5e}
  .btn.green{background:var(--accent2)}
  .btn.warn{background:var(--warn);color:#141414}
  .btn.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left;vertical-align:top}
  th{color:var(--muted);font-weight:500}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;background:#1a2235;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:11px;margin-right:6px}
  .note{font-size:12px;color:var(--muted);margin-top:4px}
  .spacer{height:6px}
  @media (max-width:720px){
    nav{grid-template-columns:repeat(3,1fr)}
    .row.two,.row.three,.row.four{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ðŸš´ Cycling Day Planner</h1>
    <span class="pill">Day Plan</span>
    <span class="pill">Fuel</span>
    <span class="pill">Macros</span>
    <span class="pill">Rides</span>
    <span class="pill">Recovery</span>
  </header>

  <nav id="tabs">
    <button class="tab-btn active" data-tab="dayplan">Day Plan</button>
    <button class="tab-btn" data-tab="fuel">Fuel</button>
    <button class="tab-btn" data-tab="macro">Macros</button>
    <button class="tab-btn" data-tab="portions">Portions</button>
    <button class="tab-btn" data-tab="recovery">Recovery</button>
  </nav>

  <!-- Day Plan -->
  <section id="dayplan" class="tab card">
    <h2>Todayâ€™s Plan (Single Input)</h2>
    <p class="note">Fill this in once. Fuel, macros and recovery suggestions all pull from this.</p>
    <div class="row two">
      <div>
        <label>Bodyweight (kg)</label>
        <input id="dp_bw" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Ride duration (hours)</label>
        <input id="dp_hours" type="number" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Training type</label>
        <select id="dp_type">
          <option>Rest / No Ride</option>
          <option>Recovery Z1â€“Z2</option>
          <option>Endurance Z2â€“Z3</option>
          <option>Threshold / Sweetspot</option>
          <option>VO2 / Intervals</option>
          <option>Race / Hard Group Ride</option>
        </select>
      </div>
      <div>
        <label>Strength today?</label>
        <select id="dp_strength">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Next hard session inâ€¦</label>
        <select id="dp_nextHard">
          <option value="gt48">&gt; 48 hours</option>
          <option value="24to48">24â€“48 hours</option>
          <option value="lt24">&lt; 24 hours</option>
        </select>
      </div>
      <div>
        <label>Heat acclimating?</label>
        <select id="dp_heat">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Current time</label>
        <select id="dp_time">
          <option value="am">Morning</option>
          <option value="pm">Afternoon</option>
          <option value="eve">Evening / Pre-bed</option>
        </select>
      </div>
      <div></div>
    </div>
    <div class="spacer"></div>
    <button class="btn green" onclick="saveDayPlan()">Save Day Plan &amp; Update</button>
    <button class="btn alt" onclick="resetDayPlan()">Clear</button>

    <div class="spacer"></div>
    <div class="row three">
      <div class="stat">
        <b>Planned load</b>
        <span id="dp_summary_type" class="big">â€”</span>
        <div class="note" id="dp_summary_note"></div>
      </div>
      <div class="stat">
        <b>Fuel focus</b>
        <span id="dp_summary_fuel" class="big">â€”</span>
      </div>
      <div class="stat">
        <b>Recovery focus</b>
        <span id="dp_summary_rec" class="big">â€”</span>
      </div>
    </div>
  </section>

  <!-- Fuel Timing -->
  <section id="fuel" class="tab card" style="display:none">
    <h2>Fuel Timing (auto from Day Plan)</h2>
    <p class="note">You can override fields, but by default theyâ€™re set from your Day Plan.</p>

    <div class="row two">
      <div>
        <label>Bodyweight (kg)</label>
        <input id="ft_bw" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Ride duration (hours)</label>
        <input id="ft_hours" type="number" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>On-bike carb rate (g/hr) <span class="note">(blank = from Day Plan)</span></label>
        <input id="ft_rate" type="number" step="1" inputmode="numeric">
      </div>
      <div>
        <label>Auto rate suggestion</label>
        <div class="stat"><span id="ft_auto" class="big">â€”</span> <span class="muted">g/hr</span></div>
      </div>
      <div>
        <label>Environment (Â°C)</label>
        <input id="ft_temp" type="number" step="1" inputmode="numeric" placeholder="e.g. 10">
      </div>
    </div>

    <div class="row two">
      <div>
        <label><input type="checkbox" id="ft_hot" /> Hot Day boost (â‰¥22â€‰Â°C)</label>
        <div class="note">Adds ~+0.2 L/h fluid and +200 mg/L sodium to guidance.</div>
      </div>
      <div></div>
    </div>

    <div class="row four">
      <div class="stat"><b>Pre-ride carbs</b><span id="ft_pre" class="big">â€”</span> g</div>
      <div class="stat"><b>On-bike total</b><span id="ft_onbike" class="big">â€”</span> g</div>
      <div class="stat"><b>Post-ride carbs</b><span id="ft_post" class="big">â€”</span> g</div>
      <div class="stat"><b>Post-ride protein</b><span id="ft_prot" class="big">â€”</span> g</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>Fluids & Sodium</h2>
      <div class="row three">
        <div>
          <label>Planned fluid (L)</label>
          <input id="ft_litres" type="number" step="0.1" inputmode="decimal">
        </div>
        <div>
          <label>Drink strength (mg sodium / L)</label>
          <input id="ft_na_mgL" type="number" step="50" inputmode="numeric">
        </div>
        <div>
          <label>Estimated sweat sodium (mg/L)</label>
          <input id="ft_sweat_mgL" type="number" step="50" inputmode="numeric" placeholder="700â€“1000">
        </div>
      </div>
      <div class="row three">
        <div class="stat"><b>Total sodium from drink</b><span id="ft_na_total" class="big">â€”</span> mg</div>
        <div class="stat"><b>Fluid guide</b><span id="ft_fluid_guide" class="big">â€”</span> L</div>
        <div class="stat"><b>Sodium guide</b><span id="ft_na_guide" class="big">â€”</span> mg/L</div>
      </div>
    </div>

    <div class="spacer"></div>
    <button class="btn" onclick="calcFuel()">Recalculate Fuel</button>
    <button class="btn alt" onclick="resetFuel()">Reset Fuel</button>
  </section>

  <!-- Macro Calculator -->
  <section id="macro" class="tab card" style="display:none">
    <h2>Macro Calculator (from Day Plan)</h2>
    <p class="note">Uses Day Plan training type + duration to select day profile. You can still tweak deficit.</p>

    <div class="row two">
      <div>
        <label>Bodyweight (kg)</label>
        <input id="mc_bw" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Calorie deficit (kcal/day)</label>
        <input id="mc_def" type="number" step="10" inputmode="numeric" value="400">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>Effective day type (auto)</label>
        <div class="stat"><span id="mc_effday" class="big">â€”</span></div>
      </div>
      <div>
        <label>Long ride duration (hours)</label>
        <input id="mc_hours" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label><input type="checkbox" id="mc_autoLong" /> Override with manual long ride &gt;= 2.5 h</label>
      </div>
    </div>

    <div class="row four">
      <div class="stat"><b>Protein</b><span id="mc_pro" class="big">â€”</span> g</div>
      <div class="stat"><b>Base kcal</b><span id="mc_base" class="big">â€”</span> kcal</div>
      <div class="stat"><b>On-bike carbs</b><span id="mc_onbike" class="big">â€”</span> g</div>
      <div class="stat"><b>Target kcal</b><span id="mc_target" class="big">â€”</span> kcal</div>
    </div>
    <div class="row two">
      <div class="stat"><b>Total carbs (incl. on-bike)</b><span id="mc_carb" class="big">â€”</span> g</div>
      <div class="stat"><b>Off-bike carbs</b><span id="mc_off" class="big">â€”</span> g</div>
    </div>
    <div class="note" id="mc_effective_note"></div>

    <div class="spacer"></div>
    <button class="btn" onclick="calcMacro()">Recalculate Macros</button>
    <button class="btn alt" onclick="resetMacro()">Reset Macros</button>
  </section>

  <!-- Portion Lookup -->
  <section id="portions" class="tab card" style="display:none">
    <h2>Portion Lookup</h2>
    <p class="note">Use this with off-bike carb target from Macros to build meals.</p>
    <div class="row three">
      <div>
        <label>Search</label>
        <input id="pl_search" placeholder="rice, pasta, bagel..." oninput="renderPortions()">
      </div>
      <div>
        <label>Sort by</label>
        <select id="pl_sort" onchange="renderPortions()">
          <option value="food">Food</option>
          <option value="carbs">Carbs</option>
        </select>
      </div>
      <div>
        <label>Show</label>
        <select id="pl_filter" onchange="renderPortions()">
          <option value="all">All</option>
          <option value="dry">Dryâ†’Cooked</option>
          <option value="as">As-eaten</option>
        </select>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="stat">
      <table id="pl_table">
        <thead>
          <tr><th>Food</th><th>Dry Weight (g)</th><th>Cooked / As-eaten</th><th>Approx. Carbs (g)</th><th>Notes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Recovery Decision Helper -->
  <section id="recovery" class="tab card" style="display:none">
    <h2>Recovery Decision Helper (from Day Plan)</h2>
    <p class="note">Based on todayâ€™s training load and timing. You can still manually tweak if needed.</p>

    <div class="row two">
      <div class="stat">
        <b>Recommended today</b>
        <ul id="rec_recommend" style="padding-left:18px;margin:6px 0;"></ul>
      </div>
      <div class="stat">
        <b>Avoid / use sparingly</b>
        <ul id="rec_avoid" style="padding-left:18px;margin:6px 0;"></ul>
      </div>
    </div>
    <div class="stat" style="margin-top:10px">
      <b>Rationale</b>
      <p id="rec_reason" class="muted" style="margin:4px 0 0;"></p>
    </div>
    <div class="spacer"></div>
    <button class="btn green" onclick="calcRecovery()">Recalculate Recovery</button>
  </section>

</div>

<script>
  // ---------- Tabs ----------
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(s=>s.style.display='none');
      document.getElementById(tab).style.display = 'block';
    });
  });

  // ---------- Global Day Plan ----------
  let dayPlan = {
    weightKg: null,
    rideHours: null,
    type: "Rest / No Ride",
    strength: false,
    nextHard: "gt48",
    heat: false,
    timeOfDay: "am"
  };

  function saveDayPlan(){
    const bw = parseFloat(val('dp_bw')||'0');
    const hrs = parseFloat(val('dp_hours')||'0');
    const type = val('dp_type');
    const strength = (val('dp_strength') === 'yes');
    const nextHard = val('dp_nextHard');
    const heat = (val('dp_heat') === 'yes');
    const time = val('dp_time');

    dayPlan = { weightKg:bw||null, rideHours:hrs||0, type, strength, nextHard, heat, timeOfDay:time };
    saveKV('dayPlan', dayPlan);

    updateDayPlanSummary();
    syncDayPlanToFuel();
    syncDayPlanToMacro();
    calcFuel();
    calcMacro();
    calcRecovery();
  }

  function updateDayPlanSummary(){
    setText('dp_summary_type', dayPlan.type || 'â€”');
    let fuelFocus = 'Low carb need';
    let recFocus = 'Light mobility';

    const hrs = dayPlan.rideHours || 0;
    const hardTypes = ["Threshold / Sweetspot","VO2 / Intervals","Race / Hard Group Ride"];
    const isHard = hardTypes.includes(dayPlan.type);
    const isLong = hrs >= 2.5;

    if (isLong && !isHard) fuelFocus = 'Endurance fuel (60â€“75 g/h)';
    if (isHard && !isLong) fuelFocus = 'High-intensity fuel (70â€“90 g/h)';
    if (isHard && isLong) fuelFocus = 'Race fuel (75â€“90 g/h)';
    if (dayPlan.type==="Rest / No Ride") fuelFocus = 'Deficit / low carb base';

    if (isHard || isLong) recFocus = 'Sauna + compression + mobility';
    if (dayPlan.strength) recFocus = 'Protect strength adapts, avoid ice baths';

    setText('dp_summary_fuel', fuelFocus);
    setText('dp_summary_rec', recFocus);

    let note = [];
    if (hrs>0) note.push(`${hrs.toFixed(1)} h planned`);
    if (dayPlan.strength) note.push("Strength included");
    if (dayPlan.heat) note.push("Heat acclimation on");
    const nh = dayPlan.nextHard;
    if (nh==="gt48") note.push("Next hard >48 h");
    if (nh==="24to48") note.push("Next hard 24â€“48 h");
    if (nh==="lt24") note.push("Next hard <24 h");
    document.getElementById('dp_summary_note').textContent = note.join(" â€¢ ");
  }

  function resetDayPlan(){
    dayPlan = {
      weightKg: null,
      rideHours: null,
      type: "Rest / No Ride",
      strength: false,
      nextHard: "gt48",
      heat: false,
      timeOfDay: "am"
    };
    ['dp_bw','dp_hours'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('dp_type').value = "Rest / No Ride";
    document.getElementById('dp_strength').value = 'no';
    document.getElementById('dp_nextHard').value = 'gt48';
    document.getElementById('dp_heat').value = 'no';
    document.getElementById('dp_time').value = 'am';
    delK('dayPlan');
    updateDayPlanSummary();
    resetFuel();
    resetMacro();
    calcRecovery();
  }

  function syncDayPlanToFuel(){
    if (dayPlan.weightKg) document.getElementById('ft_bw').value = dayPlan.weightKg;
    if (isFinite(dayPlan.rideHours)) document.getElementById('ft_hours').value = dayPlan.rideHours;
  }

  function syncDayPlanToMacro(){
    if (dayPlan.weightKg) document.getElementById('mc_bw').value = dayPlan.weightKg;
    if (isFinite(dayPlan.rideHours)) document.getElementById('mc_hours').value = dayPlan.rideHours;
  }

  function carbRateFromType(type, hours){
    if (!hours || hours<=0) return 0;
    switch(type){
      case "Rest / No Ride":     return 0;
      case "Recovery Z1â€“Z2":    return (hours<1.5?20:30);
      case "Endurance Z2â€“Z3":   return (hours<3?60:70);
      case "Threshold / Sweetspot": return 70;
      case "VO2 / Intervals":   return 80;
      case "Race / Hard Group Ride": return 85;
      default: return 0;
    }
  }

  function preRideFromType(bw, type, hours){
    if (!bw) return 0;
    switch(type){
      case "Rest / No Ride":
        return Math.round(bw*0.5);
      case "Recovery Z1â€“Z2":
        return Math.round(bw*1.0);
      case "Endurance Z2â€“Z3":
        return Math.round(bw*1.5);
      case "Threshold / Sweetspot":
      case "VO2 / Intervals":
      case "Race / Hard Group Ride":
        return Math.round(bw*2.0);
      default:
        return Math.round(bw*1.2);
    }
  }

  // ---------- Fuel ----------
  function autoRate(hours){
    if (!isFinite(hours)||hours<=0) return 0;
    if (hours < 1.5) return 20;
    if (hours < 2.5) return 45;
    if (hours < 4)   return 75;
    return 90;
  }
  function fluidGuide(hours, tempC){
    let perH_low=0.5, perH_high=0.6;
    if (isFinite(tempC)){
      if (tempC>=22){ perH_low=0.8; perH_high=1.0; }
      else if (tempC>=15){ perH_low=0.6; perH_high=0.8; }
    }
    return [+(perH_low*hours).toFixed(1), +(perH_high*hours).toFixed(1)];
  }
  function calcFuel(){
    let bw   = parseFloat(val('ft_bw')||'0');
    let hrs  = parseFloat(val('ft_hours')||'0');
    const rateManual = val('ft_rate').trim();
    const temp = parseFloat(val('ft_temp'));
    const litres = parseFloat(val('ft_litres')||'0');
    const mgL = parseFloat(val('ft_na_mgL')||'0');
    const sweat = parseFloat(val('ft_sweat_mgL'));
    const hot = document.getElementById('ft_hot').checked;

    if ((!bw || bw<=0) && dayPlan.weightKg) bw = dayPlan.weightKg;
    if ((!hrs || hrs<=0) && isFinite(dayPlan.rideHours)) hrs = dayPlan.rideHours || 0;

    // Rate from type first, fallback to generic autoRate
    let rateFromType = carbRateFromType(dayPlan.type, hrs);
    let rateAutoCore = rateFromType || autoRate(hrs);
    setText('ft_auto', rateAutoCore?rateAutoCore:'â€”');

    const rate = rateManual!=='' && isFinite(parseFloat(rateManual)) ? parseFloat(rateManual) : rateAutoCore;

    const pre  = preRideFromType(bw, dayPlan.type, hrs);
    const post = Math.round(bw*1.2 || 0);
    const prot = Math.round(bw*0.4 || 0);
    const onbk = Math.round(hrs*rate || 0);

    setText('ft_pre', pre||'â€”');
    setText('ft_post', post||'â€”');
    setText('ft_prot', prot||'â€”');
    setText('ft_onbike', onbk||'â€”');

    const naTotal = Math.round((isFinite(litres)&&isFinite(mgL)) ? litres*mgL : 0);
    setText('ft_na_total', naTotal||'â€”');

    const [fLow0, fHigh0] = fluidGuide(hrs, temp);
    let fLow = fLow0, fHigh = fHigh0;
    let naGuide = '500â€“1000';
    if (isFinite(sweat) && sweat>0) naGuide = `${Math.max(300, sweat-200)}â€“${sweat+200}`;
    if (hot) {
      const add = (isFinite(hrs) ? +(0.2*hrs).toFixed(1) : 0);
      fLow = fLow0 ? +(fLow0 + add).toFixed(1) : fLow0;
      fHigh = fHigh0 ? +(fHigh0 + add).toFixed(1) : fHigh0;
      const parts = naGuide.split('â€“').map(x => parseInt(x, 10));
      if (parts.length===2 && parts.every(n=>!isNaN(n))) {
        naGuide = `${parts[0]+200}â€“${parts[1]+200}`;
      }
    }
    setText('ft_fluid_guide', (fLow&&fHigh)?`${fLow}â€“${fHigh}`:'â€”');
    setText('ft_na_guide', naGuide);

    document.getElementById('ft_bw').value = bw || '';
    document.getElementById('ft_hours').value = hrs || '';

    saveKV('ft_bw',bw); saveKV('ft_hours',hrs); saveKV('ft_rate',rateManual);
    saveKV('ft_temp', val('ft_temp')); saveKV('ft_litres', val('ft_litres')); saveKV('ft_na_mgL', val('ft_na_mgL')); saveKV('ft_sweat_mgL', val('ft_sweat_mgL'));
    saveKV('ft_hot', hot);
  }
  function resetFuel(){
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('ft_hot').checked = false;
    ['ft_auto','ft_pre','ft_post','ft_prot','ft_onbike','ft_na_total','ft_fluid_guide','ft_na_guide'].forEach(id=>setText(id,'â€”'));
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL','ft_hot'].forEach(k=>delK(k));
  }

  // ---------- Macros ----------
  const DAY_LOOKUP = {
    "Recovery": {kcal:1900, carbs:180, fat:65},
    "Moderate": {kcal:2000, carbs:220, fat:70},
    "Endurance": {kcal:2500, carbs:350, fat:80},
    "Long": {kcal:2700, carbs:400, fat:85},
    "Hard": {kcal:2400, carbs:300, fat:75}
  };

  function macroProfileFromPlan(plan){
    const hrs = plan.rideHours || 0;
    const t = plan.type;
    if (t==="Rest / No Ride") return "Recovery";
    if (t==="Recovery Z1â€“Z2") return "Recovery";
    if (t==="Endurance Z2â€“Z3") return (hrs>=3 ? "Long" : "Endurance");
    if (t==="Threshold / Sweetspot" || t==="VO2 / Intervals") return "Hard";
    if (t==="Race / Hard Group Ride") return (hrs>=3 ? "Long" : "Hard");
    return "Recovery";
  }

  function calcMacro(){
    let bw  = parseFloat(val('mc_bw')||'0');
    const def = parseFloat(val('mc_def')||'0');
    let hrs = parseFloat(val('mc_hours')||'0');
    const autoL = document.getElementById('mc_autoLong').checked;

    if ((!bw || bw<=0) && dayPlan.weightKg) bw = dayPlan.weightKg;
    if ((!hrs || hrs<=0) && isFinite(dayPlan.rideHours)) hrs = dayPlan.rideHours || 0;

    let profName = macroProfileFromPlan(dayPlan);
    if (autoL && hrs>=2.5) profName = "Long";

    const prof = DAY_LOOKUP[profName] || DAY_LOOKUP["Recovery"];
    setText('mc_effday', profName);

    const base = prof.kcal;
    const fatG = prof.fat;
    const proG = Math.round(bw*1.9);

    let onbike = 0;
    if (profName==="Long") onbike = Math.round(hrs*70);
    else if (profName==="Endurance") onbike = Math.round(hrs*50);
    else if (profName==="Hard") onbike = Math.round(hrs*60);

    const targetKcal = Math.max(1700, base - def) + (onbike*4);
    const totalCarb = Math.round((targetKcal - (proG*4) - (fatG*9))/4);
    const offBike = Math.max(0, totalCarb - onbike);

    setText('mc_pro', proG);
    setText('mc_base', base);
    setText('mc_onbike', onbike);
    setText('mc_target', Math.round(targetKcal));
    setText('mc_carb', totalCarb);
    setText('mc_off', offBike);
    document.getElementById('mc_effective_note').textContent = `Macro profile from Day Plan: ${profName}`;

    document.getElementById('mc_bw').value = bw || '';
    document.getElementById('mc_hours').value = hrs || '';
    saveKV('mc_bw',bw); saveKV('mc_def',val('mc_def')); saveKV('mc_hours',hrs); saveKV('mc_autoLong', autoL);
  }

  function resetMacro(){
    ['mc_bw','mc_def','mc_hours'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('mc_def').value = 400;
    document.getElementById('mc_autoLong').checked=false;
    ['mc_pro','mc_base','mc_onbike','mc_target','mc_carb','mc_off','mc_effday'].forEach(id=>setText(id,'â€”'));
    document.getElementById('mc_effective_note').textContent='';
    ['mc_bw','mc_def','mc_hours','mc_autoLong'].forEach(k=>delK(k));
  }

  // ---------- Portions ----------
  const PORTIONS = [
    ["White / Basmati Rice","60","180â€“200","45","Triples weight when cooked","dry"],
    ["Brown Rice","65","180","45","Higher fibre","dry"],
    ["Jasmine / Sticky Rice","60","160â€“180","45","Slightly less water","dry"],
    ["Dried Pasta (white)","75","180â€“200","55","Doubles after cooking","dry"],
    ["Wholewheat Pasta","75","200","55","More fibre","dry"],
    ["Fresh Pasta","120","150","55","Already hydrated","dry"],
    ["Quinoa","60","180","35â€“40","High in protein","dry"],
    ["Couscous / Bulgur","60","180","40","Absorbs ~3Ã— water","dry"],
    ["Oats (rolled)","40","200â€“250","25â€“27","With milk or water","dry"],
    ["Sweet Potato","â€”","200 (baked/roasted)","40â€“45","As-eaten","as"],
    ["White Potato","â€”","180â€“220","35â€“40","As-eaten","as"],
    ["Wrap / Tortilla (med)","â€”","60 each","25â€“30","As-eaten","as"],
    ["Pitta Bread (med)","â€”","70 each","40â€“45","As-eaten","as"],
    ["Bagel (plain)","â€”","85â€“90 each","50â€“55","As-eaten","as"],
    ["Bread (slice, med)","â€”","40 per slice","18â€“20","As-eaten","as"],
    ["Rice Cake","â€”","10 each","7â€“8","As-eaten","as"],
    ["Crumpet","â€”","50 each","20","As-eaten","as"],
    ["Banana (medium)","â€”","120 each","25â€“27","As-eaten","as"],
    ["Dates / Dried Fruit","â€”","30 portion","20","High GI, good on-bike","as"],
    ["Energy / Cereal Bar","â€”","50 bar","25â€“35","Check label","as"],
    ["Carb Drink Mix (80 g/L)","â€”","1000 ml","80","Adjust strength","as"]
  ];
  function renderPortions(){
    const q = (val('pl_search')||'').toLowerCase();
    const sort = val('pl_sort');
    const filt = val('pl_filter');
    let rows = PORTIONS.filter(r=>{
      const hit = r[0].toLowerCase().includes(q);
      const okType = (filt==='all') || (filt===r[5]);
      return hit && okType;
    });
    if (sort==='food') rows.sort((a,b)=>a[0].localeCompare(b[0]));
    if (sort==='carbs') rows.sort((a,b)=>{
      const ca = parseFloat(String(a[3]).split('â€“')[0])||0;
      const cb = parseFloat(String(b[3]).split('â€“')[0])||0;
      return ca-cb;
    });
    const tb = document.querySelector('#pl_table tbody');
    tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      r.slice(0,5).forEach((c)=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      tb.appendChild(tr);
    });
  }

  // ---------- Recovery ----------
  function calcRecovery(){
    const hardTypes = ["Threshold / Sweetspot","VO2 / Intervals","Race / Hard Group Ride"];
    const isHard = hardTypes.includes(dayPlan.type);
    const isLong = (dayPlan.rideHours || 0) >= 2.5;
    const strength = dayPlan.strength;
    const heat = dayPlan.heat;
    const next = dayPlan.nextHard;
    const time = dayPlan.timeOfDay;

    const rec = [];
    const avoid = [];
    let reason = [];

    // Base safe stuff
    rec.push("Mobility flow (10â€“15 min)");
    rec.push("Legs elevated 10â€“15 min");
    rec.push("Compression garments 1â€“2 h if available");

    if (isHard){
      if (next === 'gt48') {
        rec.push("Traditional sauna 15â€“20 min (2â€“4Ã—/week)");
        rec.push("Light yoga / breathing in evening");
        avoid.push("Ice bath / cold plunge (no need, reduces adaptation)");
        reason.push("Hard session today, next hard >48 h â†’ maximise training signal.");
      } else if (next === '24to48') {
        rec.push("Traditional sauna or short contrast shower");
        rec.push("Short Z1 spin 15â€“20 min next day");
        avoid.push("Ice bath right after training");
        reason.push("Hard session today, next hard 24â€“48 h â†’ balanced recovery + adaptation.");
      } else {
        rec.push("Contrast shower 5â€“7 cycles (hot/cold)");
        rec.push("Massage gun 5â€“8 min per leg");
        rec.push("Optional compression boots if available");
        avoid.push("Long sauna (>15 min)");
        reason.push("Hard session today, next hard <24 h â†’ prioritise short-term recovery.");
      }
    } else {
      reason.push("No high-intensity session today â†’ light recovery is sufficient.");
    }

    if (strength){
      avoid.push("Ice bath or cold plunge after strength");
      avoid.push("Deep static stretching immediately post-lift");
      rec.push("Short hip/ankle-focused mobility");
      reason.push("Strength today â†’ avoid blunting hypertrophy and neural adaptation.");
    }

    if (isLong){
      rec.push("Compression garments for 2 h post-ride");
      rec.push("Easy 10â€“15 min spin or walk next morning");
      reason.push("Long ride today â†’ prioritise blood flow and gentle movement.");
    }

    if (heat){
      rec.push("Sauna 15â€“20 min if not already done");
      avoid.push("Cold plunge directly after heat exposure");
      reason.push("Heat-acclimating â†’ keep heat stress signal, avoid cancelling with cold.");
    }

    if (time === 'eve'){
      rec.push("Calm breathing / light stretching before bed");
      avoid.push("Strong cold exposure near bedtime");
      reason.push("Evening â†’ protect sleep quality and parasympathetic state.");
    }

    function unique(arr){ return [...new Set(arr)]; }
    const recU = unique(rec);
    const avoidU = unique(avoid);
    const reasonText = unique(reason).join(" ");

    const recList = document.getElementById('rec_recommend');
    const avList = document.getElementById('rec_avoid');
    recList.innerHTML = '';
    avList.innerHTML = '';

    if (!recU.length) recU.push("Normal food + sleep + easy movement.");
    recU.forEach(item=>{
      const li=document.createElement('li');
      li.textContent=item;
      recList.appendChild(li);
    });
    if (!avoidU.length) avoidU.push("Nothing major; standard recovery is fine.");
    avoidU.forEach(item=>{
      const li=document.createElement('li');
      li.textContent=item;
      avList.appendChild(li);
    });

    document.getElementById('rec_reason').textContent = reasonText || "Standard low-intensity recovery is sufficient today.";
  }

  // ---------- Helpers & Init ----------
  function setText(id, v){ document.getElementById(id).textContent = (v===0?0:(v||'â€”')); }
  function val(id){ return document.getElementById(id).value; }
  function saveKV(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function delK(k){ localStorage.removeItem(k); }
  function loadKV(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; } }

  function initDayPlan(){
    const stored = loadKV('dayPlan');
    if (stored && typeof stored === 'object'){
      dayPlan = Object.assign({
        weightKg:null, rideHours:null, type:"Rest / No Ride",
        strength:false, nextHard:"gt48", heat:false, timeOfDay:"am"
      }, stored);
      if (dayPlan.weightKg) document.getElementById('dp_bw').value = dayPlan.weightKg;
      if (isFinite(dayPlan.rideHours)) document.getElementById('dp_hours').value = dayPlan.rideHours;
      document.getElementById('dp_type').value = dayPlan.type;
      document.getElementById('dp_strength').value = dayPlan.strength?'yes':'no';
      document.getElementById('dp_nextHard').value = dayPlan.nextHard;
      document.getElementById('dp_heat').value = dayPlan.heat?'yes':'no';
      document.getElementById('dp_time').value = dayPlan.timeOfDay;
    }
    updateDayPlanSummary();
  }

  function initFuel(){
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL'].forEach(id=>{
      const v=loadKV(id); if(v!==null) document.getElementById(id).value=v;
    });
    const hotSaved = loadKV('ft_hot'); if (hotSaved!==null) document.getElementById('ft_hot').checked = hotSaved;
    syncDayPlanToFuel();
    calcFuel();
  }

  function initMacro(){
    const v1=loadKV('mc_bw'); if(v1!==null) document.getElementById('mc_bw').value=v1;
    const v2=loadKV('mc_def'); if(v2!==null) document.getElementById('mc_def').value=v2;
    const v4=loadKV('mc_hours'); if(v4!==null) document.getElementById('mc_hours').value=v4;
    const v5=loadKV('mc_autoLong'); if(v5!==null) document.getElementById('mc_autoLong').checked=v5;
    syncDayPlanToMacro();
    calcMacro();
  }

  window.addEventListener('load', ()=>{
    initDayPlan();
    initFuel();
    initMacro();
    renderPortions();
    calcRecovery();
  });
</script>
</body>
</html>


<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cycling Fuel & Macro Toolkit (+Presets, Hot Day, IF/TSS)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
  :root{
    --bg:#0b0e14; --card:#121826; --card2:#0f1421; --txt:#e9eef7; --muted:#aab4c8;
    --accent:#4f7cff; --accent2:#27c1a5; --warn:#f7b955; --danger:#ff6b6b; --ok:#7dd87d;
    --border:#26304a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  header h1{font-size:20px;margin:0}
  nav{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:12px 0}
  .tab-btn{background:var(--card);border:1px solid var(--border);color:var(--txt);padding:10px;border-radius:12px;text-align:center}
  .tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h2{font-size:18px;margin:0 0 8px;color:var(--muted)}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card2);color:var(--txt)}
  input[type="number"]{appearance:textfield}
  .row{display:grid;gap:10px}
  .row.two{grid-template-columns:1fr 1fr}
  .row.three{grid-template-columns:1fr 1fr 1fr}
  .row.four{grid-template-columns:repeat(4,1fr)}
  .stat{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:10px}
  .stat b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .big{font-size:20px}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;text-decoration:none}
  .btn.alt{background:#2e3b5e}
  .btn.green{background:var(--accent2)}
  .btn.warn{background:var(--warn);color:#141414}
  .btn.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
  th{color:var(--muted)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;background:#1a2235;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px;margin-right:6px}
  .note{font-size:13px;color:var(--muted)}
  .spacer{height:6px}
  @media (max-width:720px){ .row.two,.row.three,.row.four{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üö¥ Cycling Fuel & Macro Toolkit</h1>
    <span class="pill">Offline</span>
    <span class="pill">Local only</span>
  </header>

  <nav id="tabs">
    <button class="tab-btn active" data-tab="fuel">Fuel Timing</button>
    <button class="tab-btn" data-tab="macro">Macro Calculator</button>
    <button class="tab-btn" data-tab="portions">Portion Lookup</button>
    <button class="tab-btn" data-tab="rides">Ride Log</button>
  </nav>

  <!-- Fuel Timing -->
  <section id="fuel" class="tab card">
    <h2>Fuel Timing Calculator</h2>
    <div class="row two">
      <div>
        <label>Bodyweight (kg)</label>
        <input id="ft_bw" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Ride duration (hours)</label>
        <input id="ft_hours" type="number" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>On-bike carb rate (g/hr) <span class="note">(blank = auto)</span></label>
        <input id="ft_rate" type="number" step="1" inputmode="numeric" placeholder="">
      </div>
      <div>
        <label>Auto rate suggestion</label>
        <div class="stat"><span id="ft_auto" class="big">‚Äî</span> <span class="muted">g/hr</span></div>
      </div>
      <div>
        <label>Environment (¬∞C) <span class="note">(affects fluid guide)</span></label>
        <input id="ft_temp" type="number" step="1" inputmode="numeric" placeholder="e.g. 8">
      </div>
    </div>

    <!-- Hot Day toggle -->
    <div class="row two">
      <div>
        <label><input type="checkbox" id="ft_hot" /> Hot Day boost (‚â•22‚Äâ¬∞C)</label>
        <div class="note">Adds ~+0.2‚ÄâL/h to fluid guide and +200‚Äâmg/L to sodium guidance.</div>
      </div>
      <div></div>
    </div>

    <div class="row four">
      <div class="stat"><b>Pre-ride carbs</b><span id="ft_pre" class="big">‚Äî</span> g</div>
      <div class="stat"><b>On-bike total</b><span id="ft_onbike" class="big">‚Äî</span> g</div>
      <div class="stat"><b>Post-ride carbs</b><span id="ft_post" class="big">‚Äî</span> g</div>
      <div class="stat"><b>Post-ride protein</b><span id="ft_prot" class="big">‚Äî</span> g</div>
    </div>

    <!-- Sodium & Fluids -->
    <div class="card" style="margin-top:12px">
      <h2>Fluids & Sodium</h2>
      <div class="row three">
        <div>
          <label>Planned fluid (L)</label>
          <input id="ft_litres" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 2.0">
        </div>
        <div>
          <label>Drink strength (mg sodium / L)</label>
          <input id="ft_na_mgL" type="number" step="50" inputmode="numeric" placeholder="e.g. 800">
        </div>
        <div>
          <label>Estimated sweat sodium (mg/L)</label>
          <input id="ft_sweat_mgL" type="number" step="50" inputmode="numeric" placeholder="700‚Äì1000">
        </div>
      </div>
      <div class="row three">
        <div class="stat"><b>Total sodium from drink</b><span id="ft_na_total" class="big">‚Äî</span> mg</div>
        <div class="stat"><b>Fluid guide</b><span id="ft_fluid_guide" class="big">‚Äî</span> L (target)</div>
        <div class="stat"><b>Sodium guide</b><span id="ft_na_guide" class="big">‚Äî</span> mg/L</div>
      </div>

      <!-- QUICK PRESETS: Fuel Timing -->
      <div class="spacer"></div>
      <h2>Quick Presets</h2>
      <div class="row four">
        <button class="btn" onclick="presetFuel('z2_90_cool')">Z2 ‚Ä¢ 90 min ‚Ä¢ Cool</button>
        <button class="btn" onclick="presetFuel('end_2h30_mild')">Endurance ‚Ä¢ 2.5 h ‚Ä¢ Mild</button>
        <button class="btn" onclick="presetFuel('end_4h_hot')">Endurance ‚Ä¢ 4 h ‚Ä¢ Hot</button>
        <button class="btn" onclick="presetFuel('race_5h_hot')">Race ‚Ä¢ 5 h ‚Ä¢ Hot</button>
      </div>
    </div>

    <div class="spacer"></div>
    <div>
      <button class="btn" onclick="calcFuel()">Calculate</button>
      <button class="btn alt" onclick="resetFuel()">Reset</button>
    </div>
    <p class="note">Auto carb rate: &lt;1.5 h ‚Üí 20 g/h; 1.5‚Äì2.5 h ‚Üí 45 g/h; 2.5‚Äì4 h ‚Üí 75 g/h; ‚â•4 h ‚Üí 90 g/h. You can override with your own rate.</p>
  </section>

  <!-- Macro Calculator -->
  <section id="macro" class="tab card" style="display:none">
    <h2>Macro Calculator (per day)</h2>
    <div class="row two">
      <div>
        <label>Bodyweight (kg)</label>
        <input id="mc_bw" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Calorie deficit (kcal/day)</label>
        <input id="mc_def" type="number" step="10" inputmode="numeric" value="400">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>Day type</label>
        <select id="mc_day">
          <option>Mon - Strength+Z2</option>
          <option>Tue - Z2/3</option>
          <option>Wed - Strength+Z2</option>
          <option>Thu - Z2/3</option>
          <option>Fri - Recovery Z2</option>
          <option>Sat - Long 3-4h</option>
          <option>Sun - Endurance 2h</option>
        </select>
      </div>
      <div>
        <label>Long ride duration (hours)</label>
        <input id="mc_hours" type="number" step="0.1" inputmode="decimal" value="0">
      </div>
      <div>
        <label><input type="checkbox" id="mc_autoLong" /> Auto ‚ÄúLong 3‚Äì4h‚Äù when hours ‚â• 2.5</label>
      </div>
    </div>

    <div class="row four">
      <div class="stat"><b>Protein</b><span id="mc_pro" class="big">‚Äî</span> g</div>
      <div class="stat"><b>Base kcal</b><span id="mc_base" class="big">‚Äî</span> kcal</div>
      <div class="stat"><b>On-bike carbs</b><span id="mc_onbike" class="big">‚Äî</span> g</div>
      <div class="stat"><b>Target kcal</b><span id="mc_target" class="big">‚Äî</span> kcal</div>
    </div>
    <div class="row two">
      <div class="stat"><b>Total carbs (incl. on-bike)</b><span id="mc_carb" class="big">‚Äî</span> g</div>
      <div class="stat"><b>Off-bike carbs</b><span id="mc_off" class="big">‚Äî</span> g</div>
    </div>
    <div class="note" id="mc_effective_note"></div>

    <!-- QUICK PRESETS: Macro Calculator -->
    <div class="spacer"></div>
    <h2>Day Presets</h2>
    <div class="row four">
      <button class="btn" onclick="presetMacro('Fri - Recovery Z2',0,400,false)">Recovery (low)</button>
      <button class="btn" onclick="presetMacro('Tue - Z2/3',1.5,400,false)">Z2 ‚Ä¢ 90 min</button>
      <button class="btn" onclick="presetMacro('Sat - Long 3-4h',3.5,400,true)">Long ‚Ä¢ 3.5 h</button>
      <button class="btn" onclick="presetMacro('Sun - Endurance 2h',2,400,false)">Endurance ‚Ä¢ 2 h</button>
    </div>

    <div class="spacer"></div>
    <div>
      <button class="btn" onclick="calcMacro()">Calculate</button>
      <button class="btn alt" onclick="resetMacro()">Reset</button>
    </div>
    <p class="note">Macro logic: Base kcal by day type ‚Üí minus deficit ‚Üí plus on-bike calories (4 kcal/g). Carbs back-calculated after protein (1.9 g/kg) and fat (lookup). Auto-Long overrides day type if enabled.</p>
  </section>

  <!-- Portion Lookup -->
  <section id="portions" class="tab card" style="display:none">
    <h2>Portion Lookup (dry ‚Üî cooked + carbs)</h2>
    <div class="row three">
      <div>
        <label>Search</label>
        <input id="pl_search" placeholder="rice, pasta, bagel..." oninput="renderPortions()">
      </div>
      <div>
        <label>Sort by</label>
        <select id="pl_sort" onchange="renderPortions()">
          <option value="food">Food</option>
          <option value="carbs">Carbs</option>
        </select>
      </div>
      <div>
        <label>Show</label>
        <select id="pl_filter" onchange="renderPortions()">
          <option value="all">All</option>
          <option value="dry">Dry‚ÜíCooked</option>
          <option value="as">As-eaten</option>
        </select>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="stat">
      <table id="pl_table">
        <thead>
          <tr><th>Food</th><th>Dry Weight (g)</th><th>Cooked / As-eaten</th><th>Approx. Carbs (g)</th><th>Notes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="note">Dry weights for grains/pasta/oats; as-eaten for bread, wraps, fruit, bars.</p>
  </section>

  <!-- Ride Log -->
  <section id="rides" class="tab card" style="display:none">
    <h2>Ride Log & IF/TSS</h2>
    <div class="row three">
      <div>
        <label>Date</label>
        <input id="rl_date" type="date">
      </div>
      <div>
        <label>Duration (h)</label>
        <input id="rl_hours" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 4.87">
      </div>
      <div>
        <label>Avg Power (W)</label>
        <input id="rl_avg" type="number" step="1" inputmode="numeric">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>FTP (W)</label>
        <input id="rl_ftp" type="number" step="1" inputmode="numeric" placeholder="e.g. 267">
      </div>
      <div>
        <label>Normalized Power (W)</label>
        <input id="rl_np" type="number" step="1" inputmode="numeric" placeholder="e.g. 197">
      </div>
      <div>
        <label>CHO Intake (g)</label>
        <input id="rl_cho" type="number" step="1" inputmode="numeric">
      </div>
    </div>
    <div class="row three">
      <div>
        <label>Fluids (L)</label>
        <input id="rl_fluid" type="number" step="0.1" inputmode="decimal">
      </div>
      <div>
        <label>Notes</label>
        <input id="rl_notes" maxlength="120">
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn green" onclick="addRide()">Add Ride</button>
      </div>
    </div>
    <div class="row four" style="margin-top:4px">
      <div class="stat"><b>IF</b><span id="rl_if" class="big">‚Äî</span></div>
      <div class="stat"><b>TSS</b><span id="rl_tss" class="big">‚Äî</span></div>
      <div class="stat"><b>Total Work (kJ)</b><span id="rl_kj" class="big">‚Äî</span></div>
      <div class="stat"><b>kcal (‚âàkJ)</b><span id="rl_kcal" class="big">‚Äî</span></div>
    </div>
    <div class="spacer"></div>
    <div>
      <button class="btn alt" onclick="calcIF()">Calc IF/TSS</button>
      <button class="btn warn" onclick="exportCSV()">Export CSV</button>
      <button class="btn danger" onclick="wipeRides()">Delete All</button>
    </div>
    <div class="spacer"></div>
    <div class="stat">
      <table id="rl_table">
        <thead><tr><th>Date</th><th>Hours</th><th>Avg W</th><th>FTP</th><th>NP</th><th>IF</th><th>TSS</th><th>kJ</th><th>CHO (g)</th><th>Fluids (L)</th><th>Notes</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  // ---------- Tabs ----------
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(s=>s.style.display='none');
      document.getElementById(tab).style.display = 'block';
    });
  });

  // ---------- Fuel Timing ----------
  function autoRate(hours){
    if (!isFinite(hours)||hours<=0) return 0;
    if (hours < 1.5) return 20;
    if (hours < 2.5) return 45;
    if (hours < 4)   return 75;
    return 90;
  }
  function fluidGuide(hours, tempC){
    // return [low, high] liters for total ride
    let perH_low=0.5, perH_high=0.6;
    if (isFinite(tempC)){
      if (tempC>=22){ perH_low=0.8; perH_high=1.0; }
      else if (tempC>=15){ perH_low=0.6; perH_high=0.8; }
    }
    return [+(perH_low*hours).toFixed(1), +(perH_high*hours).toFixed(1)];
  }
  function calcFuel(){
    const bw   = parseFloat(val('ft_bw')||'0');
    const hrs  = parseFloat(val('ft_hours')||'0');
    const rateManual = val('ft_rate').trim();
    const temp = parseFloat(val('ft_temp'));
    const litres = parseFloat(val('ft_litres')||'0');
    const mgL = parseFloat(val('ft_na_mgL')||'0');
    const sweat = parseFloat(val('ft_sweat_mgL'));
    const hot = document.getElementById('ft_hot').checked;

    const rateAuto = autoRate(hrs);
    setText('ft_auto', rateAuto?rateAuto:'‚Äî');
    const rate = rateManual!=='' && isFinite(parseFloat(rateManual)) ? parseFloat(rateManual) : rateAuto;

    const pre  = Math.round(bw*1.5);
    const post = Math.round(bw*1.2);
    const prot = Math.round(bw*0.4);
    const onbk = Math.round(hrs*rate);

    setText('ft_pre', pre||'‚Äî');
    setText('ft_post', post||'‚Äî');
    setText('ft_prot', prot||'‚Äî');
    setText('ft_onbike', onbk||'‚Äî');

    // sodium totals
    const naTotal = Math.round((isFinite(litres)&&isFinite(mgL)) ? litres*mgL : 0);
    setText('ft_na_total', naTotal||'‚Äî');

    // fluid guide base
    const [fLow0, fHigh0] = fluidGuide(hrs, temp);
    let fLow = fLow0, fHigh = fHigh0;

    // sodium guide: default 500‚Äì1000 mg/L; if sweat sodium known, center ¬±200
    let naGuide = '500‚Äì1000';
    if (isFinite(sweat) && sweat>0) naGuide = `${Math.max(300, sweat-200)}‚Äì${sweat+200}`;

    // Hot Day adjustments
    if (hot) {
      const add = (isFinite(hrs) ? +(0.2*hrs).toFixed(1) : 0);
      fLow = fLow0 ? +(fLow0 + add).toFixed(1) : fLow0;
      fHigh = fHigh0 ? +(fHigh0 + add).toFixed(1) : fHigh0;

      // bump sodium range +200 mg/L
      const parts = naGuide.split('‚Äì').map(x => parseInt(x, 10));
      if (parts.length===2 && parts.every(n=>!isNaN(n))) {
        naGuide = `${parts[0]+200}‚Äì${parts[1]+200}`;
      }
    }

    setText('ft_fluid_guide', (fLow&&fHigh)?`${fLow}‚Äì${fHigh}`:'‚Äî');
    setText('ft_na_guide', naGuide);

    // persist
    saveKV('ft_bw',bw); saveKV('ft_hours',hrs); saveKV('ft_rate',rateManual);
    saveKV('ft_temp', val('ft_temp')); saveKV('ft_litres', val('ft_litres')); saveKV('ft_na_mgL', val('ft_na_mgL')); saveKV('ft_sweat_mgL', val('ft_sweat_mgL'));
    saveKV('ft_hot', hot);
  }
  function resetFuel(){
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('ft_hot').checked = false;
    ['ft_auto','ft_pre','ft_post','ft_prot','ft_onbike','ft_na_total','ft_fluid_guide','ft_na_guide'].forEach(id=>setText(id,'‚Äî'));
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL','ft_hot'].forEach(k=>delK(k));
  }

  // Fuel Timing PRESETS
  function presetFuel(key){
    const bw = parseFloat(document.getElementById('ft_bw').value || '0') || 78; // keep existing or default
    let hrs=0, temp=12, rate='', litres='', mgL=800, sweat=900, hot=false;

    if (key==='z2_90_cool'){ hrs=1.5; temp=10; rate=''; litres=0.9; mgL=700; sweat=800; hot=false; }
    if (key==='end_2h30_mild'){ hrs=2.5; temp=18; rate=''; litres=1.7; mgL=800; sweat=900; hot=false; }
    if (key==='end_4h_hot'){ hrs=4.0; temp=25; rate=''; litres=3.4; mgL=900; sweat=1000; hot=true; }
    if (key==='race_5h_hot'){ hrs=5.0; temp=27; rate=90; litres=4.0; mgL=1000; sweat=1100; hot=true; }

    document.getElementById('ft_bw').value = bw;
    document.getElementById('ft_hours').value = hrs;
    document.getElementById('ft_rate').value = rate;
    document.getElementById('ft_temp').value = temp;
    document.getElementById('ft_litres').value = litres;
    document.getElementById('ft_na_mgL').value = mgL;
    document.getElementById('ft_sweat_mgL').value = sweat;
    document.getElementById('ft_hot').checked = hot;

    calcFuel();
  }

  // ---------- Macro Calculator ----------
  const DAY_LOOKUP = {
    "Mon - Strength+Z2": {kcal:2400, carbs:300, fat:75},
    "Tue - Z2/3": {kcal:2000, carbs:200, fat:70},
    "Wed - Strength+Z2": {kcal:2400, carbs:300, fat:75},
    "Thu - Z2/3": {kcal:2000, carbs:200, fat:70},
    "Fri - Recovery Z2": {kcal:1900, carbs:180, fat:65},
    "Sat - Long 3-4h": {kcal:2700, carbs:400, fat:85},
    "Sun - Endurance 2h": {kcal:2500, carbs:350, fat:80}
  };
  function effectiveDay(day, hours, autoLong){
    if (autoLong && isFinite(hours) && hours>=2.5) return "Sat - Long 3-4h";
    return day;
  }
  function calcMacro(){
    const bw  = parseFloat(val('mc_bw')||'0');
    const def = parseFloat(val('mc_def')||'0');
    const day = val('mc_day');
    const hrs = parseFloat(val('mc_hours')||'0');
    const autoL = document.getElementById('mc_autoLong').checked;

    const eff = effectiveDay(day, hrs, autoL);
    const base = DAY_LOOKUP[eff]?.kcal || 0;
    const fatG = DAY_LOOKUP[eff]?.fat || 0;
    const proG = Math.round(bw*1.9);

    // on-bike carbs: long & endurance scaling
    let onbike = 0;
    if (eff==="Sat - Long 3-4h") onbike = Math.round(hrs*70);
    else if (eff==="Sun - Endurance 2h") onbike = Math.round(hrs*50);

    const targetKcal = Math.max(1700, base - def) + (onbike*4);
    const totalCarb = Math.round((targetKcal - (proG*4) - (fatG*9))/4);
    const offBike = Math.max(0, totalCarb - onbike);

    setText('mc_pro', proG);
    setText('mc_base', base);
    setText('mc_onbike', onbike);
    setText('mc_target', Math.round(targetKcal));
    setText('mc_carb', totalCarb);
    setText('mc_off', offBike);
    document.getElementById('mc_effective_note').textContent = (eff!==day) ? `Effective day type: ${eff} (auto-long active)` : `Effective day type: ${eff}`;

    // persist
    saveKV('mc_bw',val('mc_bw')); saveKV('mc_def',val('mc_def')); saveKV('mc_day',day); saveKV('mc_hours',val('mc_hours')); saveKV('mc_autoLong', autoL);
  }
  function resetMacro(){
    ['mc_bw','mc_def','mc_hours'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('mc_day').selectedIndex=0;
    document.getElementById('mc_autoLong').checked=false;
    ['mc_pro','mc_base','mc_onbike','mc_target','mc_carb','mc_off'].forEach(id=>setText(id,'‚Äî'));
    document.getElementById('mc_effective_note').textContent='';
    ['mc_bw','mc_def','mc_day','mc_hours','mc_autoLong'].forEach(k=>delK(k));
  }

  // Macro PRESETS
  function presetMacro(dayType, hours, deficit, autoLong){
    document.getElementById('mc_day').value = dayType;
    document.getElementById('mc_hours').value = hours;
    document.getElementById('mc_def').value = deficit;
    document.getElementById('mc_autoLong').checked = !!autoLong;
    calcMacro();
  }

  // ---------- Portions ----------
  const PORTIONS = [
    ["White / Basmati Rice","60","180‚Äì200","45","Triples weight when cooked","dry"],
    ["Brown Rice","65","180","45","Higher fibre","dry"],
    ["Jasmine / Sticky Rice","60","160‚Äì180","45","Slightly less water","dry"],
    ["Dried Pasta (white)","75","180‚Äì200","55","Doubles after cooking","dry"],
    ["Wholewheat Pasta","75","200","55","More fibre","dry"],
    ["Fresh Pasta","120","150","55","Already hydrated","dry"],
    ["Quinoa","60","180","35‚Äì40","High in protein","dry"],
    ["Couscous / Bulgur","60","180 (hydrated)","40","Absorbs ~3√ó water","dry"],
    ["Oats (rolled)","40","200‚Äì250 (porridge)","25‚Äì27","With milk or water","dry"],
    ["Sweet Potato","‚Äî","200 (baked/roasted)","40‚Äì45","As-eaten","as"],
    ["White Potato","‚Äî","180‚Äì220 (boiled/baked)","35‚Äì40","As-eaten","as"],
    ["Wrap / Tortilla (med)","‚Äî","60 each","25‚Äì30","As-eaten","as"],
    ["Pitta Bread (med)","‚Äî","70 each","40‚Äì45","As-eaten","as"],
    ["Bagel (plain)","‚Äî","85‚Äì90 each","50‚Äì55","As-eaten","as"],
    ["Bread (slice, med)","‚Äî","40 per slice","18‚Äì20","As-eaten","as"],
    ["Rice Cake","‚Äî","10 each","7‚Äì8","As-eaten","as"],
    ["Crumpet","‚Äî","50 each","20","As-eaten","as"],
    ["Banana (medium)","‚Äî","120 each","25‚Äì27","As-eaten","as"],
    ["Dates / Dried Fruit","‚Äî","30 portion","20","High GI, good on-bike","as"],
    ["Energy / Cereal Bar","‚Äî","50 bar","25‚Äì35","Check label","as"],
    ["Carb Drink Mix (80 g/L)","‚Äî","1000 ml","80","Adjust strength","as"]
  ];
  function renderPortions(){
    const q = (val('pl_search')||'').toLowerCase();
    const sort = val('pl_sort');
    const filt = val('pl_filter');
    let rows = PORTIONS.filter(r=>{
      const hit = r[0].toLowerCase().includes(q);
      const okType = (filt==='all') || (filt===r[5]);
      return hit && okType;
    });
    if (sort==='food') rows.sort((a,b)=>a[0].localeCompare(b[0]));
    if (sort==='carbs') rows.sort((a,b)=>{
      const ca = parseFloat(String(a[3]).split('‚Äì')[0])||0;
      const cb = parseFloat(String(b[3]).split('‚Äì')[0])||0;
      return ca-cb;
    });
    const tb = document.querySelector('#pl_table tbody');
    tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      r.slice(0,5).forEach((c)=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      tb.appendChild(tr);
    });
  }

  // ---------- Ride Log & IF/TSS ----------
  function calcIF(){
    const ftp = parseFloat(val('rl_ftp')||'0');
    const np  = parseFloat(val('rl_np')||'0');
    const hrs = parseFloat(val('rl_hours')||'0');
    const avg = parseFloat(val('rl_avg')||'0');

    const IF = (ftp>0 && np>0) ? (np/ftp) : 0;
    const TSS = (hrs>0) ? (hrs * IF * IF * 100) : 0;
    const kJ = (hrs>0 && avg>0) ? Math.round(avg * hrs * 3600 / 1000) : 0;

    setText('rl_if', IF ? IF.toFixed(2) : '‚Äî');
    setText('rl_tss', TSS ? Math.round(TSS) : '‚Äî');
    setText('rl_kj', kJ || '‚Äî');
    setText('rl_kcal', kJ || '‚Äî');

    return {IF, TSS, kJ};
  }
  function getRides(){ try{ return JSON.parse(localStorage.getItem('rides')||'[]'); }catch(e){ return [] } }
  function setRides(arr){ localStorage.setItem('rides', JSON.stringify(arr)); }
  function addRide(){
    const metrics = calcIF();
    const obj = {
      date: val('rl_date'),
      hours: parseFloat(val('rl_hours')||'0'),
      avg: parseFloat(val('rl_avg')||'0'),
      ftp: parseFloat(val('rl_ftp')||'0'),
      np:  parseFloat(val('rl_np')||'0'),
      IF: +metrics.IF.toFixed(2) || '',
      TSS: Math.round(metrics.TSS) || '',
      kJ: metrics.kJ || '',
      cho: parseFloat(val('rl_cho')||'0'),
      fluid: parseFloat(val('rl_fluid')||'0'),
      notes: val('rl_notes')||''
    };
    if(!obj.date){ alert('Please set a date'); return; }
    const rides = getRides(); rides.push(obj); setRides(rides); renderRides(); clearRideForm();
  }
  function clearRideForm(){ ['rl_date','rl_hours','rl_avg','rl_ftp','rl_np','rl_cho','rl_fluid','rl_notes'].forEach(id=>document.getElementById(id).value=''); ['rl_if','rl_tss','rl_kj','rl_kcal'].forEach(id=>setText(id,'‚Äî')); }
  function renderRides(){
    const tb = document.querySelector('#rl_table tbody'); tb.innerHTML='';
    getRides().forEach((r,i)=>{
      const tr=document.createElement('tr');
      ['date','hours','avg','ftp','np','IF','TSS','kJ','cho','fluid','notes'].forEach(k=>{
        const td=document.createElement('td'); td.textContent = (r[k]!==undefined?r[k]:''); tr.appendChild(td);
      });
      const td=document.createElement('td');
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='Delete';
      del.onclick=()=>{ const arr=getRides(); arr.splice(i,1); setRides(arr); renderRides(); };
      td.appendChild(del); tr.appendChild(td);
      tb.appendChild(tr);
    });
  }
  function exportCSV(){
    const rides = getRides();
    if(!rides.length){ alert('No rides to export'); return; }
    const headers = ['date','hours','avg_power','ftp','np','IF','TSS','kJ','carbs_g','fluids_l','notes'];
    const lines = [headers.join(',')].concat(
      rides.map(r=>[r.date,r.hours,r.avg,r.ftp,r.np,r.IF,r.TSS,r.kJ,r.cho,r.fluid,('"'+(r.notes||'').replace(/"/g,'""')+'"')].join(','))
    );
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='ride-log.csv'; a.click();
    URL.revokeObjectURL(url);
  }
  function wipeRides(){ if(confirm('Delete ALL rides?')){ localStorage.removeItem('rides'); renderRides(); } }

  // ---------- Helpers & Init ----------
  function setText(id, v){ document.getElementById(id).textContent = (v===0?0:(v||'‚Äî')); }
  function val(id){ return document.getElementById(id).value; }
  function saveKV(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function delK(k){ localStorage.removeItem(k); }
  function loadKV(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; } }

  function initFuel(){
    ['ft_bw','ft_hours','ft_rate','ft_temp','ft_litres','ft_na_mgL','ft_sweat_mgL'].forEach(id=>{
      const v=loadKV(id); if(v!==null) document.getElementById(id).value=v;
    });
    const hotSaved = loadKV('ft_hot'); if (hotSaved!==null) document.getElementById('ft_hot').checked = hotSaved;
    calcFuel();
  }
  function initMacro(){
    const v1=loadKV('mc_bw'); if(v1!==null) document.getElementById('mc_bw').value=v1;
    const v2=loadKV('mc_def'); if(v2!==null) document.getElementById('mc_def').value=v2;
    const v3=loadKV('mc_day'); if(v3!==null) document.getElementById('mc_day').value=v3;
    const v4=loadKV('mc_hours'); if(v4!==null) document.getElementById('mc_hours').value=v4;
    const v5=loadKV('mc_autoLong'); if(v5!==null) document.getElementById('mc_autoLong').checked=v5;
    calcMacro();
  }

  window.addEventListener('load', ()=>{
    initFuel();
    initMacro();
    renderPortions();
    renderRides();
  });
</script>
</body>
</html>
